<div class="profile-page" *ngIf="profileUser">
  <div class="profile-header">
    <div class="cover-photo">
      <img *ngIf="hasValidCoverPhoto()" [src]="userCoverPhoto" alt="Cover Photo" class="cover-image" />
      <div *ngIf="!hasValidCoverPhoto()" class="cover-fallback">
        <div class="cover-pattern"></div>
      </div>
    </div>

    <div class="profile-info">
      <div class="profile-picture">
        <div class="avatar-container">
          <img *ngIf="hasValidAvatar()" [src]="userAvatar" alt="Profile Picture" class="avatar-image" />
          <div *ngIf="!hasValidAvatar()" class="avatar-fallback" [style.background-color]="getAvatarColor()">
            <span class="avatar-initial">{{ getAvatarInitial() }}</span>
          </div>
        </div>
        <button *ngIf="isOwnProfile" class="edit-profile-btn" (click)="editProfile()">
          <i class="fas fa-edit"></i>
          Edit Profile
        </button>
        <button *ngIf="!isOwnProfile" class="follow-btn" 
                [class.following]="isFollowing"
                [disabled]="isLoadingFollow"
                (click)="toggleFollow()">
          <i class="fas" [class.fa-user-plus]="!isFollowing" [class.fa-user-check]="isFollowing"></i>
          <span *ngIf="!isLoadingFollow">{{ isFollowing ? 'Following' : 'Follow' }}</span>
          <span *ngIf="isLoadingFollow">
            <i class="fas fa-spinner fa-spin"></i>
          </span>
        </button>
      </div>

      <div class="user-details">
        <h1 class="user-name">
          <span *ngIf="profileUser.firstName && profileUser.lastName">{{ profileUser.firstName }} {{ profileUser.lastName }}</span>
          <span *ngIf="!profileUser.firstName || !profileUser.lastName">{{ profileUser.username }}</span>
        </h1>
        <p class="user-username">&#64;{{ profileUser.username }}</p>
        
        <div class="user-bio">
          <p class="bio-text">{{ profileUser.bio }}</p>
        </div>
        
        <div class="user-stats">
          <div class="stat-item" (click)="openFollowingModal()" style="cursor: pointer;">
            <span class="stat-number">{{ followingCount }}</span>
            <span class="stat-label">Following</span>
          </div>
          <div class="stat-item" (click)="openFollowersModal()" style="cursor: pointer;">
            <span class="stat-number">{{ followersCount }}</span>
            <span class="stat-label">Followers</span>
          </div>
          <div class="stat-item">
            <span class="stat-number">{{ userPosts.length }}</span>
            <span class="stat-label">Posts</span>
          </div>
          <div class="stat-item">
            <span class="stat-number">{{ totalLikesCount }}</span>
            <span class="stat-label">Likes</span>
          </div>
        </div>
        
        <div class="user-contact" *ngIf="isOwnProfile && profileUser.email">
          <div class="contact-item">
            <i class="fas fa-envelope"></i>
            <span>{{ profileUser.email }}</span>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="profile-nav">
    <div class="nav-tabs">
      <button class="nav-tab" [class.active]="activeTab === 'posts'" (click)="setActiveTab('posts')">
        <i class="fas fa-list"></i>
        <span>Posts</span>
      </button>
      <button class="nav-tab" [class.active]="activeTab === 'likes'" (click)="setActiveTab('likes')">
        <i class="fas fa-heart"></i>
        <span>Likes</span>
      </button>
      <button class="nav-tab" [class.active]="activeTab === 'bookmarks'" (click)="setActiveTab('bookmarks')">
        <i class="fas fa-bookmark"></i>
        <span>Bookmarks</span>
      </button>
    </div>
  </div>

  <div class="profile-content">
    <div class="posts-section" *ngIf="activeTab === 'posts'">
      <div class="create-post-container" *ngIf="isOwnProfile && userPosts.length > 0">
        <button class="create-post-btn" (click)="createPost()">
          <div class="post-avatar">
            <img *ngIf="hasValidAvatar()" [src]="userAvatar" alt="User Avatar" />
            <div *ngIf="!hasValidAvatar()" class="avatar-text" [style.background-color]="getAvatarColor()">
              {{ getAvatarInitial() }}
            </div>
          </div>
          <span class="create-post-text">What's on your mind?</span>
        </button>
      </div>

      <div class="loading-posts" *ngIf="isLoadingPosts">
        <div class="spinner"></div>
        <p>Loading posts...</p>
      </div>

      <div class="posts-list" *ngIf="!isLoadingPosts && userPosts.length > 0">
        <div class="post-card" *ngFor="let post of userPosts">
          <div class="post-header">
            <div class="post-avatar" [style.background-color]="getAvatarColor()" (click)="navigateToUserProfile(post.username)" style="cursor: pointer;">
              <img *ngIf="hasValidAvatar()" [src]="userAvatar" alt="User Avatar" />
              <div *ngIf="!hasValidAvatar()" class="avatar-text" [style.color]="getTextColor(getAvatarColor())">
                {{ getAvatarInitial() }}
              </div>
            </div>
            <div class="post-user-info">
              <h4 class="post-username" (click)="navigateToUserProfile(post.username)" style="cursor: pointer;">{{ post.username || 'User' }}</h4>
              <p class="post-time">{{ post.createdAt | date:'medium' }}</p>
            </div>
            <div class="post-actions-right" *ngIf="isCurrentUserPost(post)">
              <button class="action-btn more-options" (click)="togglePostMenu(post.postId, $event)">
                <i class="fas fa-ellipsis-h"></i>
              </button>
              <div class="post-dropdown-menu" [class.show]="isMenuOpen(post.postId)">
                <button class="dropdown-item delete-btn" (click)="onDeletePost(post.postId, $event)">
                  <i class="fas fa-trash"></i> Delete
                </button>
              </div>
            </div>
          </div>

          <div class="post-content">
            <p class="post-text">{{ post.content }}</p>

            <div 
              class="post-images {{ 'image-count-' + post.imageUrls.length }}" 
              *ngIf="post.imageUrls && post.imageUrls.length > 0"
            >
              <img 
                *ngFor="let imageUrl of post.imageUrls; let i = index"
                [src]="getPostImageUrl(imageUrl)" 
                alt="Post image" 
                class="post-image"
                (click)="openMediaViewer(post.imageUrls, i, 'image')"
                loading="lazy"
              >
            </div>

            <div class="post-videos" *ngIf="post.videoUrls && post.videoUrls.length > 0">
              <video 
                *ngFor="let videoUrl of post.videoUrls; let i = index"
                [src]="getPostImageUrl(videoUrl)"
                (click)="$event.preventDefault(); openMediaViewer(post.videoUrls, i, 'video')"
                controls
                class="post-video">
              </video>
            </div>
          </div>

          <div class="post-actions">
            <button 
              class="action-btn like-btn" 
              [class.liked]="post.isLikedByCurrentUser"
              [disabled]="isLiking(post.postId)"
              (click)="toggleLike(post)"
            >
              <i class="fas fa-heart" *ngIf="post.isLikedByCurrentUser"></i>
              <i class="far fa-heart" *ngIf="!post.isLikedByCurrentUser"></i>
              <i class="fas fa-spinner fa-spin" *ngIf="isLiking(post.postId)"></i>
              <span>{{ post.likeCount || 0 }}</span>
            </button>
            <button class="action-btn">
              <i class="fas fa-comment"></i>
              <span>0</span>
            </button>
            <button class="action-btn">
              <i class="fas fa-share"></i>
            </button>
          </div>
        </div>
      </div>

      <div class="empty-state posts-empty" *ngIf="!isLoadingPosts && userPosts.length === 0">
        <div class="empty-icon-container">
          <div class="empty-icon posts-icon">
            <i class="fas fa-feather-alt"></i>
          </div>
          <div class="empty-icon-bg"></div>
        </div>
        <div class="empty-content">
          <ng-container *ngIf="isOwnProfile">
            <h3>No posts yet</h3>
            <p>Share your thoughts, photos, and moments with your followers. Your posts will appear here.</p>
            <div class="empty-suggestion">
              <i class="fas fa-lightbulb"></i>
              <span>Tip: Click the button below to create your first post and start sharing!</span>
            </div>
            <button class="create-post-btn enhanced" (click)="createPost()">
              <i class="fas fa-plus"></i>
              Create your first post
            </button>
          </ng-container>
          <ng-container *ngIf="!isOwnProfile">
            <h3>No posts yet</h3>
            <p>{{ profileUser?.username || 'This user' }} hasn't shared any posts yet. Check back later for updates!</p>
            <div class="empty-suggestion">
              <i class="fas fa-info-circle"></i>
              <span>New posts from {{ profileUser?.username || 'this user' }} will appear here when they start sharing.</span>
            </div>
          </ng-container>
        </div>
      </div>
    </div>

    <div class="likes-section" *ngIf="activeTab === 'likes'">
      <div class="loading-posts" *ngIf="isLoadingLikedPosts">
        <div class="spinner"></div>
        <p>Loading liked posts...</p>
      </div>

      <div class="posts-list" *ngIf="!isLoadingLikedPosts && likedPosts.length > 0">
        <div class="post-card" *ngFor="let post of likedPosts">
          <div class="post-header">
            <div class="post-avatar" (click)="navigateToUserProfile(post.username)" style="cursor: pointer;">
              <img *ngIf="post.userAvatar" [src]="getPostUserAvatarUrl(post.userAvatar)" alt="User Avatar" />
              <div *ngIf="!post.userAvatar" class="avatar-text" [style.background-color]="getAvatarColor(post.username)" [style.color]="getTextColor(getAvatarColor(post.username))">
                {{ getAvatarInitial(post.username) }}
              </div>
            </div>
            <div class="post-user-info">
              <h4 class="post-username" (click)="navigateToUserProfile(post.username)" style="cursor: pointer;">{{ post.username || 'User' }}</h4>
              <p class="post-time">{{ post.createdAt | date:'medium' }}</p>
            </div>
            <div class="post-actions-right" *ngIf="isCurrentUserPost(post)">
              <button class="action-btn more-options" (click)="togglePostMenu(post.postId, $event)">
                <i class="fas fa-ellipsis-h"></i>
              </button>
              <div class="post-dropdown-menu" [class.show]="isMenuOpen(post.postId)">
                <button class="dropdown-item delete-btn" (click)="onDeletePost(post.postId, $event)">
                  <i class="fas fa-trash"></i> Delete
                </button>
              </div>
            </div>
          </div>

          <div class="post-content">
            <p class="post-text">{{ post.content }}</p>

            <div 
              class="post-images {{ 'image-count-' + post.imageUrls.length }}" 
              *ngIf="post.imageUrls && post.imageUrls.length > 0"
            >
              <img 
                *ngFor="let imageUrl of post.imageUrls; let i = index"
                [src]="getPostImageUrl(imageUrl)" 
                alt="Post image" 
                class="post-image"
                (click)="openMediaViewer(post.imageUrls, i, 'image')"
                loading="lazy"
              >
            </div>

            <div class="post-videos" *ngIf="post.videoUrls && post.videoUrls.length > 0">
              <video 
                *ngFor="let videoUrl of post.videoUrls; let i = index"
                [src]="getPostImageUrl(videoUrl)"
                (click)="$event.preventDefault(); openMediaViewer(post.videoUrls, i, 'video')"
                controls
                class="post-video">
              </video>
            </div>
          </div>

          <div class="post-actions">
            <button 
              class="action-btn like-btn" 
              [class.liked]="post.isLikedByCurrentUser"
              [disabled]="isLiking(post.postId)"
              (click)="toggleLike(post)"
            >
              <i class="fas fa-heart" *ngIf="post.isLikedByCurrentUser"></i>
              <i class="far fa-heart" *ngIf="!post.isLikedByCurrentUser"></i>
              <i class="fas fa-spinner fa-spin" *ngIf="isLiking(post.postId)"></i>
              <span>{{ post.likeCount || 0 }}</span>
            </button>
            <button class="action-btn">
              <i class="fas fa-comment"></i>
              <span>0</span>
            </button>
            <button class="action-btn">
              <i class="fas fa-share"></i>
            </button>
          </div>
        </div>
      </div>

      <div class="empty-state likes-empty" *ngIf="!isLoadingLikedPosts && likedPosts.length === 0">
        <div class="empty-icon-container">
          <div class="empty-icon likes-icon">
            <i class="fas fa-heart"></i>
          </div>
          <div class="empty-icon-bg"></div>
        </div>
        <div class="empty-content">
          <ng-container *ngIf="isOwnProfile">
            <h3>No liked posts yet</h3>
            <p>When you like posts, they'll appear here so you can easily find them later.</p>
            <div class="empty-suggestion">
              <i class="fas fa-lightbulb"></i>
              <span>Tip: Double-tap or click the heart icon on posts you enjoy!</span>
            </div>
          </ng-container>
          <ng-container *ngIf="!isOwnProfile">
            <h3>No liked posts</h3>
            <p>{{ profileUser?.username || 'This user' }} hasn't liked any posts yet.</p>
            <div class="empty-suggestion">
              <i class="fas fa-info-circle"></i>
              <span>Liked posts will appear here when they start engaging with content.</span>
            </div>
          </ng-container>
        </div>
      </div>
    </div>

    <div class="bookmarks-section" *ngIf="activeTab === 'bookmarks'">
      <div class="empty-state bookmarks-empty">
        <div class="empty-icon-container">
          <div class="empty-icon bookmarks-icon">
            <i class="fas fa-bookmark"></i>
          </div>
          <div class="empty-icon-bg"></div>
        </div>
        <div class="empty-content">
          <ng-container *ngIf="isOwnProfile">
            <h3>No bookmarks yet</h3>
            <p>Save posts you want to read later by bookmarking them. They'll appear here for easy access.</p>
            <div class="empty-suggestion">
              <i class="fas fa-lightbulb"></i>
              <span>Tip: Click the bookmark icon on any post to save it for later!</span>
            </div>
          </ng-container>
          <ng-container *ngIf="!isOwnProfile">
            <h3>Bookmarks are private</h3>
            <p>Only {{ profileUser?.username || 'this user' }} can see their saved posts and bookmarks.</p>
            <div class="empty-suggestion privacy-note">
              <i class="fas fa-lock"></i>
              <span>This section is private to protect user privacy.</span>
            </div>
          </ng-container>
        </div>
      </div>
    </div>
  </div>
  <div class="media-viewer-overlay" *ngIf="showMediaViewer" (click)="closeMediaViewer()">
    <div class="media-viewer-container" (click)="$event.stopPropagation()">
      <button class="close-button" (click)="closeMediaViewer()">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <line x1="18" y1="6" x2="6" y2="18"></line>
          <line x1="6" y1="6" x2="18" y2="18"></line>
        </svg>
      </button>
      
      <ng-container *ngIf="currentMediaType === 'image'">
        <img [src]="currentMediaUrls[currentMediaIndex]" class="media-content" alt="Media content" />
      </ng-container>
      
      <ng-container *ngIf="currentMediaType === 'video'">
        <video [src]="currentMediaUrls[currentMediaIndex]" class="media-content" controls autoplay></video>
      </ng-container>
      
      <div class="media-navigation">
        <button (click)="$event.stopPropagation(); navigateMedia('prev')" *ngIf="currentMediaUrls.length > 1">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <polyline points="15 18 9 12 15 6"></polyline>
          </svg>
        </button>
        <div></div> 
        <button (click)="$event.stopPropagation(); navigateMedia('next')" *ngIf="currentMediaUrls.length > 1">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <polyline points="9 18 15 12 9 6"></polyline>
          </svg>
        </button>
      </div>
      
      <div class="media-counter" *ngIf="currentMediaUrls.length > 1">
        {{ currentMediaIndex + 1 }} / {{ currentMediaUrls.length }}
      </div>
    </div>
  </div>

  <div class="modal-overlay" *ngIf="showFollowersModal" (click)="closeFollowersModal()">
    <div class="modal-container" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h3>Followers</h3>
        <button class="close-button" (click)="closeFollowersModal()">
          <i class="fas fa-times"></i>
        </button>
      </div>
      <div class="modal-content">
        <div class="loading-container" *ngIf="isLoadingModal">
          <div class="spinner"></div>
          <p>Loading followers...</p>
        </div>
        <div class="users-list" *ngIf="!isLoadingModal">
          <div class="user-item" *ngFor="let user of followersList" (click)="navigateToUser(user.username)">
            <div class="user-avatar">
              <img *ngIf="user.avatarUrl" [src]="getUserAvatarUrl(user)" [alt]="user.username" />
              <div *ngIf="!user.avatarUrl" class="avatar-fallback-small">
                <span class="avatar-initial-small">{{ user.username.charAt(0).toUpperCase() }}</span>
              </div>
            </div>
            <div class="user-info">
              <h4 class="username">{{ user.username }}</h4>
              <p class="bio" *ngIf="user.bio">{{ user.bio }}</p>
            </div>
          </div>
          <div class="empty-state" *ngIf="followersList.length === 0">
            <p>No followers yet</p>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="modal-overlay" *ngIf="showFollowingModal" (click)="closeFollowingModal()">
    <div class="modal-container" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h3>Following</h3>
        <button class="close-button" (click)="closeFollowingModal()">
          <i class="fas fa-times"></i>
        </button>
      </div>
      <div class="modal-content">
        <div class="loading-container" *ngIf="isLoadingModal">
          <div class="spinner"></div>
          <p>Loading following...</p>
        </div>
        <div class="users-list" *ngIf="!isLoadingModal">
          <div class="user-item" *ngFor="let user of followingList" (click)="navigateToUser(user.username)">
            <div class="user-avatar">
              <img *ngIf="user.avatarUrl" [src]="getUserAvatarUrl(user)" [alt]="user.username" />
              <div *ngIf="!user.avatarUrl" class="avatar-fallback-small">
                <span class="avatar-initial-small">{{ user.username.charAt(0).toUpperCase() }}</span>
              </div>
            </div>
            <div class="user-info">
              <h4 class="username">{{ user.username }}</h4>
              <p class="bio" *ngIf="user.bio">{{ user.bio }}</p>
            </div>
          </div>
          <div class="empty-state" *ngIf="followingList.length === 0">
            <p>Not following anyone yet</p>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="loading-container" *ngIf="!profileUser && !isLoadingProfile">
  <div class="spinner"></div>
  <p>Loading user information...</p>
</div>

<div class="loading-container" *ngIf="isLoadingProfile">
  <div class="spinner"></div>
  <p>Loading profile...</p>
</div> 